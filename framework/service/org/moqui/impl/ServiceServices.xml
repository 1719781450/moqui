<?xml version="1.0" encoding="UTF-8"?>
<!--
This is free and unencumbered software released into the public domain.
For specific language governing permissions and limitations refer to
the LICENSE.md file or http://unlicense.org
-->
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-1.5.xsd">

    <service verb="clean" noun="SchedulerHistory" authenticate="false" transaction-timeout="600">
        <in-parameters><parameter name="daysToKeep" type="Integer" default="90"/></in-parameters>
        <out-parameters><parameter name="recordsRemoved" type="Long"/></out-parameters>
        <actions>
            <script>
                import org.moqui.context.ExecutionContext
                import org.moqui.entity.EntityCondition
                ExecutionContext ec = context.ec
                Calendar basisCal = ec.user.getCalendarSafe()
                basisCal.add(Calendar.DAY_OF_YEAR, (int) -daysToKeep)
                basisTimestamp = new Timestamp(basisCal.getTimeInMillis())
                recordsRemoved = ec.entity.find("moqui.service.scheduler.SchedulerHistory")
                        .condition("eventDate", EntityCondition.LESS_THAN, basisTimestamp)
                        .disableAuthz().deleteAll()
            </script>
            <log level="info" message="Removed ${recordsRemoved} SchedulerHistory records."/>
        </actions>
    </service>
</services>
