<?xml version="1.0" encoding="UTF-8"?>
<!--
This is free and unencumbered software released into the public domain.
For specific language governing permissions and limitations refer to
the LICENSE.md file or http://unlicense.org
-->
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-1.5.xsd">

    <service verb="clean" noun="ArtifactData" authenticate="false" transaction-timeout="600">
        <in-parameters><parameter name="daysToKeep" type="Integer" default="90"/></in-parameters>
        <out-parameters>
            <parameter name="artifactHitsRemoved" type="Long"/>
            <parameter name="artifactHitBinsRemoved" type="Long"/>
        </out-parameters>
        <actions>
            <script>
                import org.moqui.context.ExecutionContext
                import org.moqui.entity.EntityCondition
                ExecutionContext ec = context.ec
                Calendar basisCal = ec.user.getCalendarSafe()
                basisCal.add(Calendar.DAY_OF_YEAR, (int) -daysToKeep)
                basisTimestamp = new Timestamp(basisCal.getTimeInMillis())
                artifactHitsRemoved = ec.entity.find("moqui.server.ArtifactHit")
                        .condition("startDateTime", EntityCondition.LESS_THAN, basisTimestamp)
                        .disableAuthz().deleteAll()
                artifactHitBinsRemoved = ec.entity.find("moqui.server.ArtifactHitBin")
                        .condition("binEndDateTime", EntityCondition.LESS_THAN, basisTimestamp)
                        .disableAuthz().deleteAll()
            </script>
            <log level="info" message="Removed ${artifactHitsRemoved} ArtifactHit records and ${artifactHitBinsRemoved} ArtifactHitBin records."/>
        </actions>
    </service>
</services>
